<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Chat — Hi Interviews</title>
  <meta name="description" content="Manage all platform conversations." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: { 50:'#f8fafc',100:'#eef2f7',200:'#e5eaf1',300:'#cfd8e3',400:'#94a3b8',500:'#64748b',600:'#475569',700:'#334155',800:'#1e293b',900:'#0f172a',950:'#0c1324' },
            brand: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' },
          }
        }
      }
    }
  </script>

  <style>
    /* little triangle tails for message bubbles */
    .bubble-left::after {
      content: '';
      position: absolute;
      left: -6px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid white; /* same as bubble bg */
      filter: drop-shadow(-1px 0 0 rgba(0,0,0,0.02));
    }
    .bubble-right::after {
      content: '';
      position: absolute;
      right: -6px;
      top: 12px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 8px solid #eef2ff; /* same as bubble bg */
      filter: drop-shadow(1px 0 0 rgba(0,0,0,0.02));
    }
    /* scroll bar smaller */
    .thin-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
    .thin-scroll::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.18); border-radius: 8px; }
    .thin-scroll::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body class="bg-ink-50 text-ink-900 antialiased font-sans flex flex-col h-screen">

  <div class="flex h-full">
    <!-- Left Panel: Conversation List -->
    <aside id="leftPanel" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-ink-200 flex flex-col h-full">
      <div class="p-4 border-b border-ink-100 flex items-center justify-between gap-4">
        <div>
          <h1 class="text-lg font-bold text-ink-800">Admin Inbox</h1>
          <p class="text-xs text-ink-500 mt-0.5">Manage platform conversations</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="newConversationBtn" class="text-ink-600 hover:text-ink-900" title="New conversation">
            <i class="fa-solid fa-plus"></i>
          </button>
        </div>
      </div>

      <div id="searchWrap" class="p-3 border-b border-ink-100">
        <input id="searchInput" type="text" placeholder="Search conversations, names..." class="w-full px-3 py-2 rounded-lg bg-ink-50 border border-ink-100 text-sm focus:outline-none focus:ring-2 focus:ring-brand-200" />
      </div>

      <div id="convoList" class="flex-grow overflow-y-auto thin-scroll">
        <!-- conversation groups & items injected -->
      </div>

      <div class="p-3 border-t text-xs text-ink-500">
        Tip: click a conversation to open. New messages blink.
      </div>
    </aside>

    <!-- Right Panel: Active Chat Window -->
    <main id="chatPanel" class="w-2/3 hidden md:flex flex-col h-full">
      <div id="headerBar" class="p-4 border-b border-ink-100 bg-white flex items-center gap-3">
          <button id="backToListBtn" class="md:hidden text-ink-600 hover:text-ink-900">
              <i class="fa-solid fa-arrow-left"></i>
          </button>
          <img id="activeAvatar" src="https://placehold.co/40x40/1e293b/e2e8f0?text=A" class="h-10 w-10 rounded-full flex-shrink-0">
          <div class="flex-grow">
              <h2 id="activeChatName" class="font-semibold text-ink-800">Select a conversation</h2>
              <p id="activeChatMeta" class="text-xs text-ink-500 mt-0.5">Status: idle</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="callBtn" class="hidden md:inline-flex items-center gap-2 px-3 py-2 bg-ink-50 border border-ink-100 rounded-lg text-sm text-ink-600 hover:bg-ink-100">
              <i class="fa-solid fa-phone"></i> Call
            </button>
            <button id="moreBtn" class="text-ink-600 hover:text-ink-900"><i class="fa-solid fa-ellipsis-vertical"></i></button>
          </div>
      </div>

      <div id="chatWindow" class="flex-grow p-6 overflow-y-auto thin-scroll bg-gradient-to-b from-white to-ink-50">
        <div id="welcomeMessage" class="text-center text-ink-500 mt-20">
            <i class="fa-solid fa-inbox text-5xl"></i>
            <p class="mt-2">Select a conversation from the left to view messages.</p>
        </div>
        <!-- messages inserted here -->
      </div>

      <div class="p-4 border-t border-ink-100 bg-white">
        <form id="chatForm" class="flex items-center gap-3" onsubmit="return false;">
            <input type="text" id="messageInput" placeholder="Type your reply..." class="w-full h-10 px-3 text-sm rounded-lg border border-ink-100 bg-ink-50 flex-grow disabled:opacity-60" required disabled>
            <button type="submit" id="sendBtn" class="h-10 px-4 bg-brand-600 text-white rounded-lg flex items-center justify-center gap-2 hover:bg-brand-700 transition disabled:opacity-60" disabled>
                <i class="fa-solid fa-paper-plane"></i>
                <span class="hidden sm:inline">Send</span>
            </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Data: conversations with dummy Indian texts (messages in Hindi/English)
    const conversations = {
      'amit-kumar': {
        id: 'amit-kumar',
        name: 'Amit Kumar',
        type: 'candidate_chat',
        avatarUrl: 'https://placehold.co/100x100/1e293b/e2e8f0?text=AK',
        unread: 2,
        lastMessage: 'Kal subah 10 baje theek rahega?',
        messages: [
          { from: 'them', text: 'Namaste! Main Amit hoon. Interview ke liye thank you.', time: '2025-09-07 10:02' },
          { from: 'me', text: 'Aapka swagat hai. Kal subah 10 baje free hoon.', time: '2025-09-07 10:04' },
          { from: 'them', text: 'Kal subah 10 baje theek rahega?', time: '2025-09-07 10:06' }
        ]
      },
      'monica-geller': {
        id: 'monica-geller',
        name: 'Monica Geller',
        type: 'buddy_request',
        avatarUrl: 'https://placehold.co/100x100/e0e7ff/312e81?text=M',
        unread: 1,
        lastMessage: 'Slot confirm kar sakte hain kya?',
        messages: [
          { from: 'them', text: 'Hi. Kya aap meri remaining slots confirm kar sakte hain?', time: '2025-09-06 15:12' }
        ]
      },
      'kevin-mathew': {
        id: 'kevin-mathew',
        name: 'Kevin Mathew',
        type: 'trainer_chat',
        avatarUrl: 'https://placehold.co/100x100/312e81/e0e7ff?text=KM',
        unread: 0,
        lastMessage: 'Okay, I will handle that request.',
        messages: [
          { from: 'them', text: 'Okay, I will handle that request.', time: '2025-09-05 09:30' },
          { from: 'me', text: 'Thanks, Kevin!', time: '2025-09-05 09:32' }
        ]
      },
      'prakash-rao': {
        id: 'prakash-rao',
        name: 'Prakash Rao',
        type: 'other',
        avatarUrl: 'https://placehold.co/100x100/f3f4f6/4b5563?text=PR',
        unread: 1,
        lastMessage: 'Corporate packages rate bhej dein.',
        messages: [
          { from: 'them', text: 'Corporate packages ki rate bhej dein. Humein bulk booking karni hai.', time: '2025-09-03 11:05' }
        ]
      }
    };

    let activeConvoId = null;

    // Elements
    const convoListEl = document.getElementById('convoList');
    const chatWindowEl = document.getElementById('chatWindow');
    const activeChatNameEl = document.getElementById('activeChatName');
    const activeChatMetaEl = document.getElementById('activeChatMeta');
    const activeAvatarEl = document.getElementById('activeAvatar');
    const welcomeMessageEl = document.getElementById('welcomeMessage');
    const messageInputEl = document.getElementById('messageInput');
    const sendBtnEl = document.getElementById('sendBtn');
    const chatFormEl = document.getElementById('chatForm');
    const searchInputEl = document.getElementById('searchInput');

    function formatTime(ts) {
      // very simple formatting; expects 'YYYY-MM-DD HH:mm'
      const t = ts.split(' ')[1] || ts;
      return t;
    }

    function renderConvoList(filter = '') {
      const groups = {
        buddy_request: { title: 'Buddy Day Requests', items: [] },
        trainer_chat: { title: 'Trainer Chats', items: [] },
        candidate_chat: { title: 'Candidate Chats', items: [] },
        other: { title: 'Other Inquiries', items: [] }
      };

      // sort by unread then most recent (simple)
      const entries = Object.values(conversations).sort((a, b) => {
        if (a.unread !== b.unread) return b.unread - a.unread;
        return (b.messages?.[b.messages.length-1]?.time || '').localeCompare(a.messages?.[a.messages.length-1]?.time || '');
      });

      for (const convo of entries) {
        if (filter && !convo.name.toLowerCase().includes(filter.toLowerCase()) && !convo.lastMessage.toLowerCase().includes(filter.toLowerCase())) continue;
        groups[convo.type].items.push(convo);
      }

      convoListEl.innerHTML = Object.values(groups).map(group => {
        if (!group.items.length) return '';
        return `
          <div class="px-4 pt-4 pb-2 text-xs font-semibold text-ink-500 uppercase tracking-wider">${group.title}</div>
          ${group.items.map(c => `
            <button dataConvoId="${c.id}" class="w-full text-left p-3 border-b border-ink-100 hover:bg-ink-50 transition flex items-center gap-3 ${c.id === activeConvoId ? 'bg-brand-50' : ''}">
              <div class="relative">
                <img src="${c.avatarUrl}" class="h-10 w-10 rounded-full flex-shrink-0">
                ${c.unread > 0 ? `<div class="absolute -top-0.5 -right-0.5 h-5 w-5 bg-rose-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">${c.unread}</div>` : ''}
              </div>
              <div class="flex-grow overflow-hidden">
                <div class="flex items-center justify-between gap-2">
                  <p class="font-semibold text-sm truncate">${c.name}</p>
                  <p class="text-xxs text-ink-400 text-xs">${formatTime(c.messages?.[c.messages.length-1]?.time || '')}</p>
                </div>
                <p class="text-sm text-ink-600 truncate mt-1">${c.lastMessage}</p>
              </div>
            </button>
          `).join('')}
        `;
      }).join('');
    }

    function renderMessages(convoId) {
      const convo = conversations[convoId];
      if (!convo) return;
      activeConvoId = convoId;
      convo.unread = 0; // mark read
      activeChatNameEl.textContent = convo.name;
      activeChatMetaEl.textContent = `Type: ${convo.type.replace('_',' ')} • ${convo.messages.length} messages`;
      activeAvatarEl.src = convo.avatarUrl;
      welcomeMessageEl.classList.add('hidden');

      // messages markup
      chatWindowEl.innerHTML = `
        <div class="max-w-2xl mx-auto space-y-4" id="messagesWrap">
          <div class="text-center text-xs text-ink-400">Today</div>
          ${convo.messages.map(msg => {
            if (msg.from === 'me') {
              return `
                <div class="flex justify-end">
                  <div class="relative max-w-[75%]">
                    <div class="bubble-right relative px-4 py-2 rounded-2xl rounded-br-md bg-brand-50 shadow-sm">
                      <div class="text-sm text-ink-900">${escapeHtml(msg.text)}</div>
                      <div class="text-xs text-ink-400 mt-1 text-right">${formatTime(msg.time)} <i class="fa-solid fa-check text-[10px] ml-1"></i></div>
                    </div>
                  </div>
                </div>
              `;
            } else {
              return `
                <div class="flex items-start gap-3">
                  <img src="${convo.avatarUrl}" class="h-9 w-9 rounded-full flex-shrink-0">
                  <div class="relative max-w-[75%]">
                    <div class="bubble-left relative px-4 py-2 rounded-2xl rounded-bl-md bg-white shadow-sm border border-ink-50">
                      <div class="text-sm text-ink-900">${escapeHtml(msg.text)}</div>
                      <div class="text-xs text-ink-400 mt-1">${formatTime(msg.time)}</div>
                    </div>
                  </div>
                </div>
              `;
            }
          }).join('')}
        </div>
      `;

      renderConvoList(); // update list badges
      scrollChatToBottom();
      // enable input
      messageInputEl.disabled = false;
      sendBtnEl.disabled = false;
      messageInputEl.focus();
    }

    function escapeHtml(unsafe) {
      return String(unsafe)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function scrollChatToBottom() {
      setTimeout(() => {
        chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
      }, 50);
    }

    // click handler for convo list (event delegation)
    convoListEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button[dataConvoId]');
      if (!btn) return;
      const convoId = btn.getAttribute('dataConvoId');
      renderMessages(convoId);
      // on small screens hide left panel
      if (window.innerWidth < 768) {
        document.getElementById('leftPanel').classList.add('hidden');
        document.getElementById('chatPanel').classList.remove('hidden');
      }
    });

    // send message
    chatFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      sendMessageFromInput();
    });
    sendBtnEl.addEventListener('click', sendMessageFromInput);

    function sendMessageFromInput() {
      const text = messageInputEl.value.trim();
      if (!text || !activeConvoId) return;
      const now = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const timeStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      const newMsg = { from: 'me', text, time: timeStr };
      conversations[activeConvoId].messages.push(newMsg);
      conversations[activeConvoId].lastMessage = text;
      renderMessages(activeConvoId);
      messageInputEl.value = '';

      // simulate quick reply from them (demo only)
      setTimeout(() => {
        const replyTextSamples = [
          'Theek hai, milte hain kal.',
          'Shukriya! Aapka message mil gaya.',
          'Main confirm kar raha hoon, thodi der mein batata hoon.',
          'Sounds good. Thanks!'
        ];
        const replyText = replyTextSamples[Math.floor(Math.random() * replyTextSamples.length)];
        const now2 = new Date();
        const timeStr2 = `${now2.getFullYear()}-${pad(now2.getMonth()+1)}-${pad(now2.getDate())} ${pad(now2.getHours())}:${pad(now2.getMinutes())}`;
        conversations[activeConvoId].messages.push({ from: 'them', text: replyText, time: timeStr2 });
        conversations[activeConvoId].lastMessage = replyText;
        renderConvoList();
        // flash a subtle indicator on top meta
        activeChatMetaEl.classList.add('text-ink-800');
        setTimeout(()=> activeChatMetaEl.classList.remove('text-ink-800'), 1000);
        // append to chat if still active
        if (activeConvoId) renderMessages(activeConvoId);
      }, 900);
    }

    // search filter
    searchInputEl.addEventListener('input', (e) => {
      renderConvoList(e.target.value);
    });

    // responsive back button
    document.getElementById('backToListBtn').addEventListener('click', () => {
      document.getElementById('leftPanel').classList.remove('hidden');
      document.getElementById('chatPanel').classList.add('hidden');
    });

    // initial render
    renderConvoList();

    // small UX: double-click anywhere to mark all read
    convoListEl.addEventListener('dblclick', () => {
      for (const k of Object.keys(conversations)) conversations[k].unread = 0;
      renderConvoList();
    });

    // allow Enter to send
    messageInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessageFromInput();
      }
    });

    // adapt layout when resizing
    window.addEventListener('resize', () => {
      // if no active convo selected on big screens, show welcome
      if (window.innerWidth >= 768 && !activeConvoId) {
        document.getElementById('leftPanel').classList.remove('hidden');
        document.getElementById('chatPanel').classList.remove('hidden');
      }
    });

    // optional: open first convo by default (uncomment if desired)
    // renderMessages(Object.keys(conversations)[0]);
  </script>

</body>
</html>