<!doctype html>
<html lang="en" class="scroll-smooth h-full">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>Hi Interviews — Candidate Dashboard</title>
 <meta name="description" content="User dashboard — profile, purchases, tickets. Hi Interviews." />
 <link rel="icon" href="favicon.ico" sizes="any">
 <link rel="icon" href="favicon.svg" type="image/svg+xml">
 <link rel="apple-touch-icon" href="apple-touch-icon.png">
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <script src="https://cdn.tailwindcss.com"></script>

 <script>
 tailwind.config = {
 darkMode: 'media',
 theme: {
 extend: {
 colors: {
 ink: { 50: '#f8fafc', 100: '#eef2f7', 200: '#e5eaf1', 300: '#cfd8e3', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#0c1324' },
 brand: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
 'accent-iris': '#8B5CF6',
 'accent-mint': '#10B981',
 'accent-sky': '#38BDF8',
 'accent-amber': '#FBBF24',
 'accent-peach': '#FDA4AF',
 'accent-rose': '#F43F5E',
 },
 boxShadow: { soft: '0 10px 30px rgba(2,6,23,.08)', card: '0 6px 18px rgba(2,6,23,.06)', lift: '0 16px 40px rgba(2,6,23,.12)' },
 fontFamily: { sans: ["Inter", "system-ui", "-apple-system", "Segoe UI", "Helvetica", "Arial", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"], heading: ["Poppins", "sans-serif"] },
 keyframes: {
 'fade-in-up': { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
 'glow-pulse': { '0%,100%': { boxShadow: '0 0 20px rgba(251, 191, 36, 0.4), 0 0 40px rgba(251, 191, 36, 0.3)' }, '50%': { boxShadow: '0 0 30px rgba(251, 191, 36, 0.6), 0 0 60px rgba(251, 191, 36, 0.5)' } }
 },
 animation: { 'fade-in-up': 'fade-in-up 0.6s ease-out forwards', 'glow-pulse': 'glow-pulse 3s ease-in-out infinite' },
 }
 }
 }
 </script>

 <style>
 .focus-ring:focus-visible { outline: 2px solid rgba(79, 70, 229,.35); outline-offset: 3px }
 .container { max-width: 1200px }
 .card-hover-effect{transition:transform .25s ease, box-shadow .25s ease}
 .card-hover-effect:hover { transform: translateY(-0.5rem); box-shadow: 0 16px 40px rgba(2,6,23,.12); }
 .bg-pattern { background-image: radial-gradient(circle at top right, rgba(79, 70, 229,0.05) 0%, transparent 40%), radial-gradient(circle at bottom left, rgba(79, 70, 229,0.05) 0%, transparent 50%); }
 details summary::-webkit-details-marker { display: none; }
 .chevron-icon { transition: transform 0.2s ease-in-out; }
 details[open] summary .chevron-icon { transform: rotate(180deg); }
 .glossy-card::after {
 content: '';
 position: absolute;
 top: -50%;
 left: -50%;
 width: 200%;
 height: 200%;
 background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.3), transparent 30%), radial-gradient(circle at 80% 70%, rgba(255,255,255,0.2), transparent 40%);
 transition: transform 0.6s ease;
 transform: rotate(20deg);
 }
 .glass-card {
 background-color: rgba(255, 255, 255, 0.6);
 backdrop-filter: blur(12px);
 -webkit-backdrop-filter: blur(12px);
 border: 1px solid rgba(255, 255, 255, 0.3);
 }
 .promo-bar { background: linear-gradient(90deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02)); border-top: 1px solid rgba(99,102,241,0.04); border-bottom: 1px solid rgba(99,102,241,0.02); }
 /* small helper for tickets hover */
 .hoverDetail { transition: opacity .12s ease, transform .12s ease; will-change: transform, opacity; }
 </style>
</head>
<!-- Spinner overlay -->
<div id="spinner" class="fixed inset-0 flex items-center justify-center bg-white z-50" style="display:flex">
    <div class="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
</div>

<body class="min-h-screen bg-white text-ink-950 antialiased selection:bg-brand-500 selection:text-white font-sans content" style="display:none">

 <!-- Skip -->
 <a class="sr-only focus:not-sr-only focus:block p-2 m-2 rounded bg-brand-600 text-white" href="#main">Skip to content</a>

 <!-- Header (matches reference: logo + nav + promo) -->
 <header id="pageHeader" class="sticky top-0 z-50 border-b border-transparent bg-white/90 backdrop-blur transition-shadow duration-300">
 <div class="mx-auto container px-5">
 <div class="flex items-center justify-between py-4">
 <!-- Logo -->
 <a href="profile.html" class="flex items-center gap-3" aria-label="Hi Interviews home">
 <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-brand-600 to-brand-800 text-white flex items-center justify-center font-bold">HI</div>
 <div class="hidden sm:block">
 <div class="font-semibold tracking-tight text-lg font-heading text-ink-900">Hi Interviews</div>
 <div class="text-xs text-ink-500 -mt-0.5">Candidate Dashboard</div>
 </div>
 </a>

 <nav class="hidden md:flex items-center gap-4 text-sm" aria-label="Main">
 <a class="hover:text-brand-600 font-medium transition px-3 py-2 rounded-md" href="store.html">Store</a>
 <a class="hover:text-brand-600 font-medium transition px-3 py-2 rounded-md" href="#contact">Contact</a>
 <a class="hover:text-brand-600 font-medium transition px-3 py-2 rounded-md" href="#faq">FAQ</a>
 </nav>

 <div class="flex items-center gap-3">
 <button id="refreshBtnTop" class="px-3 py-1 rounded-md bg-ink-50 hover:bg-ink-100 text-sm flex items-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-300" title="Refresh dashboard">
 <i class="fa-solid fa-arrows-rotate"></i> <span class="hidden sm:inline">Refresh</span>
 </button>

 <a href="store.html" title="Go to store" class="hidden sm:inline-flex items-center justify-center h-9 w-9 rounded-full bg-white border border-ink-100 shadow-sm focus-ring" aria-label="Open store">
 <i class="fa-solid fa-shopping-cart text-ink-700"></i>
 </a>

 <button id="logoutBtnTop" class="inline-flex items-center rounded-full border border-ink-200 px-4 py-2 font-medium text-ink-700 transition-all duration-300 hover:bg-ink-50 hover:shadow-card">Logout</button>

 <button type="button" id="menuToggle" aria-label="Open menu" aria-controls="mobileNav" aria-expanded="false" class="md:hidden rounded-lg border border-ink-200 p-2 focus-ring">
 <i class="fa-solid fa-bars text-[1.25rem]" aria-hidden="true"></i>
 </button>
 </div>
 </div>
 </div>

 <!-- promo bar -->
 <div class="promo-bar">
 <div class="mx-auto container px-5 py-2 flex items-center justify-between text-sm">
 <div class="flex items-center gap-3">
 <span class="inline-flex items-center gap-2 rounded-full bg-brand-50 px-3 py-1 text-xs font-semibold text-brand-700"><i class="fa-solid fa-gift" aria-hidden="true"></i> Limited offer</span>
 <div>
 <strong class="mr-2">Flat ₹2,000 off</strong>
 <span class="text-ink-600">Use code <kbd class="px-2 py-0.5 rounded bg-ink-100 text-sm">SEPT2000</kbd> in store.</span>
 </div>
 </div>
 <div><a href="store.html" class="text-sm font-medium text-brand-700 hover:underline">Apply in store →</a></div>
 </div>
 </div>

 <!-- mobile nav -->
 <nav id="mobileNav" hidden aria-label="Mobile" class="md:hidden border-t border-ink-100 bg-white">
 <div class="mx-auto container px-5 py-3 grid gap-2 text-sm">
 <a class="rounded-lg border border-ink-200 px-3 py-2 transition hover:bg-ink-50" href="store.html">Store</a>
 <a class="rounded-lg border border-ink-200 px-3 py-2 transition hover:bg-ink-50" href="#contact">Contact</a>
 <a class="rounded-lg border border-ink-200 px-3 py-2 transition hover:bg-ink-50" href="#faq">FAQ</a>
 <a class="rounded-full border border-transparent bg-brand-600 px-4 py-2 font-medium text-white text-center" href="login.html">Login</a>
 </div>
 </nav>
 </header>

 <!-- Main layout -->
 <main id="main" tabindex="-1" class="bg-ink-50/40 min-h-[calc(100vh-160px)]">
 <div class="mx-auto container px-5 py-10 grid lg:grid-cols-12 gap-8">

 <!-- Sidebar -->
 <aside class="lg:col-span-3">
 <div class="bg-white rounded-2xl p-4 shadow-card border border-ink-100 sticky top-24">
 <div class="flex items-center gap-3">
 <div id="profileInitial" class="h-12 w-12 rounded-full bg-gradient-to-br from-brand-600 to-brand-800 text-white flex items-center justify-center font-semibold">U</div>
 <div>
<img id="profileAvatar" class="h-12 w-12 rounded-full object-cover" src="" alt="M" style="display:none">
</div>

 <div>
 <div id="sidebarName" class="font-semibold text-ink-900">User Name</div>
 <div id="sidebarEmail" class="text-xs text-ink-500">email@example.com</div>
 </div>
 </div>

 <nav class="mt-6 space-y-2" aria-label="Dashboard">
 <button data-tab="personal" class="tabBtn w-full text-left px-3 py-2 rounded-md flex items-center gap-3 text-sm bg-brand-50 text-brand-700 font-semibold">
 <i class="fa-solid fa-user"></i> Personal Details
 </button>
 <button data-tab="purchases" class="tabBtn w-full text-left px-3 py-2 rounded-md flex items-center gap-3 text-sm hover:bg-ink-50">
 <i class="fa-solid fa-box"></i> My Purchases
 </button>
 <button data-tab="tickets" class="tabBtn w-full text-left px-3 py-2 rounded-md flex items-center gap-3 text-sm hover:bg-ink-50">
 <i class="fa-solid fa-ticket"></i> Tickets
 </button>
 <button data-tab="extras" class="tabBtn w-full text-left px-3 py-2 rounded-md flex items-center gap-3 text-sm hover:bg-ink-50">
 <i class="fa-solid fa-star"></i> Extras (Coming soon)
 </button>
 </nav>

 <div class="mt-6 text-xs text-ink-500 border-t pt-4">
 <div class="font-semibold mb-2">Important — Candidate Conduct Rules</div>
 <div class="text-xs space-y-1">
 <p>To keep the platform safe and fair, the actions below are strictly prohibited. Violation may result in account termination and forfeiture of refunds.</p>
 <ul class="list-disc pl-4 mt-2">
 <li>Contacting mentors outside the platform (phone / WhatsApp / personal email).</li>
 <li>Offering or paying mentors outside the platform.</li>
 <li>Sharing personal contact details or soliciting theirs.</li>
 <li>Impersonation, fraudulent documents, or manipulating records.</li>
 <li>Harassment or threats toward staff or mentors.</li>
 </ul>
 </div>
 </div>

 <div class="mt-6 flex gap-2">
 <a href="store.html" class="flex-1 inline-flex items-center justify-center gap-2 rounded-md border border-ink-200 px-3 py-2 text-sm hover:bg-ink-50"><i class="fa-solid fa-store"></i> Go to Store</a>
 <button id="logoutBtn" class="inline-flex items-center gap-2 rounded-md bg-rose-50 text-rose-700 px-3 py-2 text-sm hover:bg-rose-100">Logout</button>
 </div>
 </div>
 </aside>

 <!-- Content area -->
 <section class="lg:col-span-9 space-y-6">
 <!-- Personal -->
<div id="tabPersonal" class="tabContent bg-white rounded-2xl p-6 shadow-card border border-ink-100">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-xl font-semibold">Personal Details</h2>
      <p class="text-sm text-ink-500">Your profile information — editable and saved via backend.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="editProfileBtn" class="px-3 py-1 rounded-md bg-ink-50 text-sm">Edit</button>
      <button id="saveProfileBtn" class="px-3 py-1 rounded-md bg-brand-600 text-white text-sm hidden">Save</button>
    </div>
  </div>

  <form id="profileForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- Profile Photo (at the top) -->
<div class="md:col-span-2">
  <label class="text-sm font-medium">Profile Photo</label>

  <!-- File input (always below label in edit mode) -->
    <div class="mt-2 flex items-center gap-3">
    <input id="avatarInput" type="file" accept="image/*" class="hidden" />
    <button id="uploadAvatarBtn"  type="button" class="px-3 py-1 bg-brand-600 text-white rounded-md text-sm hidden">Choose File</button>
  </div>

  <!-- Avatar Preview + Remove button (below file input) -->
  <div id="avatarPreviewWrap" class="mt-2 flex items-center gap-3">
    <img id="displayAvatar" class="w-24 h-24 rounded-full hidden" />
    <div id="displayInitial" class="w-24 h-24 rounded-full bg-brand-600 text-white flex items-center justify-center text-2xl font-bold hidden">U</div>
    <button type="button" id="removeAvatarBtn" class="px-3 py-1 text-red-600 text-sm hidden">Remove</button>
  </div>
</div>



    <!-- Full Name -->
    <div>
      <label class="text-sm font-medium">Full name</label>
      <input id="inputName" type="text" class="mt-1 w-full rounded border px-3 py-2 bg-ink-50" disabled />
    </div>

    <!-- Phone -->
    <div>
      <label class="text-sm font-medium">Mobile Number</label>
      <input id="inputPhone" type="tel" class="mt-1 w-full rounded border px-3 py-2 bg-ink-50" disabled />
    </div>

    <!-- Alt Phone -->
    <div>
      <label class="text-sm font-medium">Alternate Number(optional)</label>
      <input id="inputAltPhone" type="tel" class="mt-1 w-full rounded border px-3 py-2 bg-ink-50" disabled />
    </div>

    <!-- CV Upload -->
    <div class="md:col-span-2 flex items-center gap-3">
      <input id="inputCv" type="file" accept=".pdf,.doc,.docx" class="hidden" />
      <button id="uploadCvBtn" type="button" class="px-3 py-1 bg-brand-600 text-white rounded-md text-sm" disabled>Choose File</button>
      <div id="cvPreview" class="text-sm text-ink-600">No CV uploaded.</div>
      <button id="downloadCvBtn" class="ml-auto px-3 py-1 bg-ink-50 hover:bg-ink-100 rounded-md text-sm hidden">Download CV</button>
    </div>

  </form>
</div>



 <!-- Purchases -->
 <div id="tabPurchases" class="tabContent hidden bg-white rounded-2xl p-6 shadow-card border border-ink-100">
 <div class="flex items-center justify-between">
 <div>
 <h2 class="text-xl font-semibold">My Purchases</h2>
 <p class="text-sm text-ink-500">View services you've purchased, dates and statuses.</p>
 </div>

 <div class="flex items-center gap-2">
 <select id="statusFilter" class="rounded-md border px-2 py-1 text-sm">
 <option value="all">All statuses</option>
 <option value="Pending">Pending</option>
 <option value="Delivered">Delivered</option>
 <option value="Refunded">Refunded</option>
 <option value="Cancelled">Cancelled</option>
 </select>
 <input id="purchaseSearch" placeholder="Search purchases..." class="rounded-md border px-3 py-1 text-sm" />
 </div>
 </div>

 <div class="mt-4 overflow-x-auto">
 <table class="w-full text-sm table-auto">
 <thead class="text-left text-ink-600">
 <tr>
 <th class="py-2 pr-4">Order ID</th>
 <th class="py-2 pr-4">Service</th>
 <th class="py-2 pr-4">subscription_price</th>
 <th class="py-2 pr-4">Date</th>
 <th class="py-2 pr-4">Status</th>
 <th class="py-2 pr-4">Details</th>
 </tr>
 </thead>
 <tbody id="purchasesTbody" class="divide-y"></tbody>
 </table>
 </div>
 </div>

 <!-- Tickets -->
 <div id="tabTickets" class="tabContent hidden bg-white rounded-2xl p-6 shadow-card border border-ink-100">
 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 <div>
 <h2 class="text-xl font-semibold">Create New Ticket</h2>
 <p class="text-sm text-ink-500">Report an issue or ask for support — we'll respond via email.</p>

 <form id="newTicketForm" class="mt-4 grid grid-cols-1 gap-3">
 <label class="text-sm">Subject <span class="text-rose-500">*</span></label>
 <input id="ticketSubject" type="text" required class="rounded border px-3 py-2 focus-visible:ring-2 focus-visible:ring-brand-300" />
 <label class="text-sm">Related Purchase <span class="text-rose-500">*</label>
 <select id="ticketPurchaseSelect" class="rounded border px-3 py-2">
 <option value="">-- none --</option>
 </select>
 <label class="text-sm">Message <span class="text-rose-500">*</span></label>
 <textarea id="ticketMessage" rows="5" required class="rounded border px-3 py-2"></textarea>

 <div class="flex items-center gap-2">
 <button type="submit" class="px-4 py-2 bg-brand-600 text-white rounded-md">Create Ticket</button>
 <button type="reset" id="resetTicketBtn" class="px-4 py-2 rounded-md bg-ink-50 hover:bg-ink-100">Reset</button>
 </div>
 </form>
 </div>

 <div>
 <h2 class="text-xl font-semibold">Ticket History</h2>
 <p class="text-sm text-ink-500">Hover or focus a row to see full details.</p>

 <div class="mt-3 overflow-auto max-h-[360px]">
 <table class="w-full text-sm table-auto">
 <thead class="text-left text-ink-600">
 <tr>
 <th class="py-2 pr-4">Ticket ID</th>
 <th class="py-2 pr-4">Subject</th>
 <th class="py-2 pr-4">Status</th>
 <th class="py-2 pr-4">Created</th>
 </tr>
 </thead>
 <tbody id="ticketsTbody" class="divide-y"></tbody>
 </table>
 <div id="hoverTicketDetail" class="hidden absolute z-50 w-80 bg-white rounded-md shadow-lg p-3 hoverDetail"></div>
 </div>
 </div>
 </div>
 </div>

 <!-- Extras -->
 <div id="tabExtras" class="tabContent hidden bg-white rounded-2xl p-6 shadow-card border border-ink-100">
 <div class="text-center">
 <h2 class="text-xl font-semibold">Extras</h2>
 <p class="text-ink-600">Interview Buddy Day — coming soon. More features will appear here.</p>
 <div class="mt-4">
 <a href="store.html" class="px-4 py-2 bg-brand-600 text-white rounded-md">Explore Services</a>
 </div>
 </div>
 </div>

 </section>
 </div>
 </main>

 <!-- Footer -->
 <footer class="bg-ink-900 text-ink-300">
 <div class="mx-auto container px-5 py-8">
 <div class="grid gap-8 md:grid-cols-3">
 <div>
 <a href="profile.html" class="font-heading font-semibold tracking-tight text-xl text-white flex items-center gap-3">
 <div class="h-8 w-8 rounded-md bg-gradient-to-br from-brand-600 to-brand-800 text-white flex items-center justify-center font-bold">HI</div>
 Hi Interviews
 </a>
 <p class="mt-2 text-sm">Your Personal Interview Coach.</p>
 </div>

 <div>
 <h4 class="font-medium text-white">Quick Links</h4>
 <ul class="mt-4 space-y-2 text-sm">
 <li><a href="store.html" class="hover:text-white transition">Our Services</a></li>
 <li><a href="#tracks" class="hover:text-white transition">Tracks</a></li>
 <li><a href="#faq" class="hover:text-white transition">FAQ</a></li>
 </ul>
 </div>

 <div>
 <h4 class="font-medium text-white">Contact</h4>
 <ul class="mt-4 space-y-2 text-sm">
 <li><a href="mailto:hello@hiinterviews.com" class="hover:text-white transition">hello@hiinterviews.com</a></li>
 </ul>
 </div>
 </div>

 <div class="mt-8 pt-6 border-t border-ink-700 flex flex-col md:flex-row justify-between items-center text-sm">
 <p class="text-ink-400">© <span id="footerYear">2025</span> Hi Interviews. Crafted with <i class="fa-solid fa-heart text-accent-rose"></i>.</p>
 <div class="mt-3 md:mt-0 space-x-4">
 <a href="privacy_policy.html" class="hover:text-white transition">Privacy Policy</a>
 <a href="t&c.html" class="hover:text-white transition">Terms of Service</a>
 </div>
 </div>
 </div>
 </footer>

 <!-- JS (dashboard functionality) -->
 <script src="scripts/script.js"></script>
 <script>
document.addEventListener('DOMContentLoaded',()=> {

           checkWebsiteStatus().then(active => {
                 if (!active) return; 
            });


    let appState ={};
 // refs & state
//  const storageKey = 'hiInterviewsUserState_v1';
//  const defaultState = {
//  user: { name: 'Mahesh Kumar', email: 'mahesh.kumar@example.com', phone: '9876543210', location: 'Bengaluru, India', bio: 'Aspiring full-stack developer.', cvFileName: null, cvDataUrl: null },
//  purchases: [
//  { id: 'ORD-1001', subscription_domain: 'Knowledge Series — Full Stack Python', subscription_price: 59999, date: new Date().toISOString(), status: 'Delivered' },
//  { id: 'ORD-1002', subscription_domain: 'Interview Buddy Day — 1 Day', subscription_price: 12000, date: new Date(Date.now()-3*24*3600*1000).toISOString(), status: 'Pending' }
//  ],
//  tickets: [
//  { ticketId: 'TCK-9001', subject: 'Schedule change request', message: 'Request to reschedule my session to evening slot.', relatedid: 'ORD-1001', status: 'Open', createdAt: new Date().toISOString(), responses: [ { by: 'Support', text: 'We can reschedule. Please propose times.' } ] }
//  ]
//  };



 // header small behaviours
 const yearEl = document.getElementById('footerYear'); if (yearEl) yearEl.textContent = new Date().getFullYear();
 const pageHeader = document.getElementById('pageHeader');
 function handleHeaderScroll(){ if(window.scrollY>12) pageHeader.classList.add('shadow-sm','border-ink-100/80'); else pageHeader.classList.remove('shadow-sm','border-ink-100/80');}
 window.addEventListener('scroll', handleHeaderScroll, { passive:true }); handleHeaderScroll();

 // toggle mobile menu
 const menuToggle = document.getElementById('menuToggle');
 const mobileNav = document.getElementById('mobileNav');
 if (menuToggle) {
 menuToggle.addEventListener('click', () => {
 const expanded = menuToggle.getAttribute('aria-expanded') === 'true';
 menuToggle.setAttribute('aria-expanded', String(!expanded));
 mobileNav.hidden = expanded;
 document.body.style.overflow = expanded ? '' : 'hidden';
 });
 Array.from(mobileNav.querySelectorAll('a')).forEach(a => a.addEventListener('click', () => {
 if (menuToggle.getAttribute('aria-expanded') === 'true') { menuToggle.click(); }
 }));
 }

 // DOM refs for dashboard
 const tabButtons = document.querySelectorAll('.tabBtn');
 const tabContents = document.querySelectorAll('.tabContent');
 const mobileTabSelect = null; // not used in this design
 const refreshBtnTop = document.getElementById('refreshBtnTop');
 const logoutBtnTop = document.getElementById('logoutBtnTop');

 // personal form refs
  const inputName = document.getElementById("inputName");
  const inputPhone = document.getElementById("inputPhone");
  const inputAltPhone = document.getElementById("inputAltPhone");
  const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
  const avatarInput = document.getElementById("avatarInput");
  const displayAvatar = document.getElementById("displayAvatar");
  const displayInitial = document.getElementById("displayInitial");
  const removeAvatarBtn = document.getElementById("removeAvatarBtn");

  const inputCv = document.getElementById("inputCv");
  const uploadCvBtn = document.getElementById("uploadCvBtn");
  const cvPreview = document.getElementById("cvPreview");
  const downloadCvBtn = document.getElementById("downloadCvBtn");

  const editProfileBtn = document.getElementById("editProfileBtn");
  const saveProfileBtn = document.getElementById("saveProfileBtn");

 // purchases & tickets refs
 const purchasesTbody = document.getElementById('purchasesTbody');
 const statusFilter = document.getElementById('statusFilter');
 const purchaseSearch = document.getElementById('purchaseSearch');

 const ticketSubject = document.getElementById('ticketSubject');
 const ticketMessage = document.getElementById('ticketMessage');
 const ticketPurchaseSelect = document.getElementById('ticketPurchaseSelect');
 const newTicketForm = document.getElementById('newTicketForm');
 const ticketsTbody = document.getElementById('ticketsTbody');
 const hoverTicketDetail = document.getElementById('hoverTicketDetail');

 const sidebarName = document.getElementById('sidebarName');
 const sidebarEmail = document.getElementById('sidebarEmail');
 const profileAvatar = document.getElementById('profileAvatar');
  const profileInitial = document.getElementById('profileInitial');


 // helpers
 const currencyFormatter = new Intl.NumberFormat('en-IN');
 function formatRupees(n){ return '₹' + Math.round(n).toLocaleString('en-IN'); }
 function escapeHtml(text){ if(!text) return ''; return (text+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

 



 let accessToken = localStorage.getItem('accessToken');
let refreshToken = localStorage.getItem('refreshToken');

let spinner = document.getElementById("spinner");
let content = document.querySelector('.content');

if (!refreshToken) {
    clearTokensAndRedirect();
    return;
}

// --- Load Profile ---
async function loadProfile() {
  try {
    const response = await fetch('https://hiinterview-backend-1.onrender.com/api/userprofile/', {
      headers: { Authorization: `Bearer ${accessToken}` },
    });

            if (response.status === 401) {
                accessToken = await refreshAccessToken();
                if (!accessToken) return;
                refreshToken = localStorage.getItem('refreshToken');
                response = await fetch('https://hiinterview-backend-1.onrender.com/api/userprofile/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },

                });
            }

            if (response.status === 403) {
                spinner.style.display = "none";
                window.location.href = "404.html";
            } else {
                content.style.display = "block";
                spinner.style.display = "none";

            }

            if (response.ok) {
                const data = await response.json();
                console.log("data",data)

                appState = {
                    user: data,
                    purchases: data.subscription || [],
                    tickets: data.tickets || []
                    };
                   console.log("purchases",appState.purchases) 
                   console.log("tickets",appState.tickets)


                inputName.value = data.fullname || "";
                inputPhone.value = data.mobile_number || "";
                inputAltPhone.value = data.alt_mobile_number || "";
                sidebarEmail.textContent = data.email || "";
                sidebarName.textContent= data.fullname || "";

                // Profile photo
                if (data.profile_photo_url) {
                const url = 'https://hiinterview-backend-1.onrender.com';
                displayAvatar.src = `${url}${data.profile_photo_url}`;
                displayAvatar.classList.remove("hidden");
                displayInitial.classList.add("hidden");
                profileAvatar.src = `${url}${data.profile_photo_url}`;
                profileAvatar.style.display = "block";
                profileInitial.style.display = "none";
                
                } else {
                displayAvatar.classList.add("hidden");
                profileInitial.textContent = (data.fullname || "U")[0].toUpperCase();
                displayInitial.textContent = (data.fullname || "U")[0].toUpperCase();
                displayInitial.classList.remove("hidden");
                }

                // CV
                if (data.cv) {
                const fileName = data.cv.split("/").pop();
                const url = 'https://hiinterview-backend-1.onrender.com';
                const cv_url = `${url}${data.cv_url}`;
                cvPreview.textContent = fileName || "CV available";
                downloadCvBtn.classList.remove("hidden");
                downloadCvBtn.onclick = () => window.open(cv_url, "_blank");
                } else {
                cvPreview.textContent = "No CV uploaded.";
                downloadCvBtn.classList.add("hidden");
                }

                setProfileEditMode(false);
                 populateAll();
            }
            else {
                  console.error('failed to fetch user data');
              }
    } catch (err) {
        console.error("Profile load error:", err);
    }
}


async function refreshAccessToken() {
        const refreshToken = localStorage.getItem("refreshToken");
        if (!refreshToken) return null;

        try {
            const response = await fetch("https://hiinterview-backend-1.onrender.com/api/token/refresh/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ refresh: refreshToken })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem("accessToken", data.access);
                localStorage.setItem("refreshToken", data.refresh);

                return data.access;
            } else {
                clearTokensAndRedirect();
                return null;
            }
        } catch (err) {
            console.error(err);
            return null;
        }
    }

function clearTokensAndRedirect() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('role')
    window.location.href = "login.html";
}

// --- Edit Mode ---
// --- Set Edit Mode ---
function setProfileEditMode(editMode) {
  [inputName, inputPhone, inputAltPhone].forEach(el => {
    el.disabled = !editMode;
    el.classList.toggle("bg-ink-50", !editMode);
  });

  uploadCvBtn.disabled = !editMode;
  

  if (editMode) {
    editProfileBtn.classList.add("hidden");
    uploadAvatarBtn.classList.remove('hidden');
    uploadAvatarBtn.disabled = !editMode;
  uploadAvatarBtn.classList.toggle("bg-brand-600", editMode);
  uploadAvatarBtn.classList.toggle("bg-gray-300", !editMode);
    saveProfileBtn.classList.remove("hidden");


    if (displayAvatar.src) {
      // Existing photo
      displayAvatar.classList.remove("hidden");
      removeAvatarBtn.classList.remove("hidden");
    } else {
      displayAvatar.classList.add("hidden");
      removeAvatarBtn.classList.add("hidden");
    }

    // Hide first letter in edit mode
    displayInitial.classList.add("hidden");

  } else {
    editProfileBtn.classList.remove("hidden");
    saveProfileBtn.classList.add("hidden");
    removeAvatarBtn.classList.add("hidden");
    uploadAvatarBtn.classList.add('hidden');


    if (displayAvatar.src!=="") {
      displayAvatar.classList.remove("hidden");
      displayInitial.classList.add("hidden");
    } else {
      displayAvatar.classList.add("hidden");
      displayInitial.textContent = (inputName.value || "U")[0].toUpperCase();
      displayInitial.classList.remove("hidden");
    }
  }
}






// --- Edit / Save ---
editProfileBtn.addEventListener("click", () => setProfileEditMode(true));

saveProfileBtn.addEventListener("click", async function () {
     let accessToken = localStorage.getItem('accessToken');
  const formData = new FormData();
  formData.append("fullname", inputName.value.trim());
  formData.append("mobile_number", inputPhone.value.trim());
  if (inputAltPhone.value.trim()) formData.append("alt_mobile_number", inputAltPhone.value.trim());
  if (avatarInput.files[0]) formData.append("profile_photo", avatarInput.files[0]);
  if (inputCv.files[0]) formData.append("cv", inputCv.files[0]);

  try {
    const response = await fetch("https://hiinterview-backend-1.onrender.com/api/update/user-profile/", {
      method: "PUT",
      headers: { Authorization: `Bearer ${accessToken}` },
      body: formData,
    });

     if (response.status === 401) {
        accessToken = await refreshAccessToken();
        if (!accessToken) return;
        refreshToken = localStorage.getItem('refreshToken');
        response = await fetch('https://hiinterview-backend-1.onrender.com/api/update/user-profile/', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            },
            method: "PUT",
            body: formData
        });
    }
    if (response.status === 403) {
        spinner.style.display = "none";
        window.location.href = "404.html";
    } else {
        content.style.display = "block";
        spinner.style.display = "none";

    }

    if (!response.ok) throw new Error("Failed to save profile");
        const data = await response.json();
    alert("Profile updated successfully!");
    await loadProfile();

  } catch (err) {
    console.error("Save error:", err);
    alert("Error saving profile.");
  }
});

removeAvatarBtn.addEventListener("click", () => {
  avatarInput.value = "";          // clear file input
  displayAvatar.src = "";          // remove preview
  displayAvatar.classList.add("hidden");
  removeAvatarBtn.classList.add("hidden");

});

// User selects new photo
avatarInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (evt) => {
    displayAvatar.src = evt.target.result;
    displayAvatar.classList.remove("hidden");
    removeAvatarBtn.classList.remove("hidden");
  };
  reader.readAsDataURL(file);
});

// --- CV Upload ---
uploadCvBtn.addEventListener("click", () => inputCv.click());
uploadAvatarBtn.addEventListener("click", () =>avatarInput.click());

inputCv.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.type.includes("pdf") && !file.type.includes("msword")) {
    alert("Please upload a PDF or Word document.");
    inputCv.value = "";
    return;
  }
  cvPreview.textContent = file.name;
  downloadCvBtn.classList.add("hidden");
});



 // purchases rendering
 function renderPurchases(){
 const filterStatus = statusFilter.value;
 const q = (purchaseSearch.value || '').trim().toLowerCase();
 const rows = appState.purchases
 .filter(p => filterStatus === 'all' ? true : p.status === filterStatus)
 .filter(p => !q ? true : (p.subscription_domain?.toLowerCase().includes(q)));


   if (rows.length === 0) {
    purchasesTbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center py-4 text-gray-500">
          No purchases found
        </td>
      </tr>
    `;
    return;
  }

 purchasesTbody.innerHTML = rows.map(p => {
 const dateStr = new Date(p.date).toLocaleString();
 const statusStyles = {
 'Pending': 'bg-amber-100 text-amber-800',
 'Delivered': 'bg-emerald-100 text-emerald-800',
 'Refunded': 'bg-sky-100 text-sky-800',
 'Cancelled': 'bg-rose-100 text-rose-800'
 };
 const style = statusStyles[p.status] || 'bg-ink-50 text-ink-700';
 return `
 <tr class="cursor-pointer purchaseRow" data-id="${p.id}">
 <td class="py-3 pr-4">${escapeHtml(p.id)}</td>
 <td class="py-3 pr-4">${escapeHtml(p.subscription_name)}  ${escapeHtml(p.subscription_domain || '')}</td>
 <td class="py-3 pr-4">${formatRupees(p.subscription_price)}</td>
 <td class="py-3 pr-4">${escapeHtml(dateStr)}</td>
 <td class="py-3 pr-4"><span class="px-2 py-1 rounded ${style} text-xs">${escapeHtml(p.status)}</span></td>
 <td class="py-3 pr-4"><button class="text-sm text-brand-600 viewOrderBtn" data-id="${p.id}">View</button></td>
 </tr>
 `;
 }).join('');

 // attach events
 document.querySelectorAll('.viewOrderBtn').forEach(btn => btn.addEventListener('click', (e) => {
 e.stopPropagation();
 const id = btn.dataset.id;
 const order = appState.purchases.find(x => x.id == id);
 if (!order) return;
 const detail = `Order ID: ${order.id}\nService: ${order.subscription_domain || order.subscription_name}\nsubscription_price: ${formatRupees(order.subscription_price)}\nDate: ${new Date(order.date).toLocaleString()}\nStatus: ${order.status}`;
 alert(detail);
 }));

 // row click -> expand details (toggle inline)
 document.querySelectorAll('.purchaseRow').forEach(row => {
 row.addEventListener('click', () => {
 const id = row.dataset.id;
 const order = appState.purchases.find(x=>x.id==id);
 if(!order) return;
 const next = row.nextElementSibling;
 if(next && next.classList.contains('purchaseDetails')) { next.remove(); return; }
 document.querySelectorAll('.purchaseDetails').forEach(d => d.remove());
 const detailRow = document.createElement('tr');
 detailRow.className = 'purchaseDetails';
 detailRow.innerHTML = `<td colspan="6" class="py-3 text-sm text-ink-600 bg-ink-50">
 <div class="p-3 grid grid-cols-1 md:grid-cols-2 gap-2">
 <div><strong>Order ID:</strong> ${escapeHtml(order.id)}</div>
 <div><strong>Purchased on:</strong> ${new Date(order.date).toLocaleString()}</div>
 <div class="md:col-span-2"><strong>Service:</strong> ${escapeHtml(order.subscription_domain)}</div>
 <div><strong>Price:</strong> ${formatRupees(order.subscription_price)}</div>
 <div><strong>Status:</strong> ${escapeHtml(order.status)}</div>
 </div>
 </td>`;
 row.parentElement.insertBefore(detailRow, row.nextSibling);
 });
 });
 }

 statusFilter.addEventListener('change', renderPurchases);
 purchaseSearch.addEventListener('input', renderPurchases);

 // tickets rendering & hover detail
 function renderTicketPurchaseOptions(){
 ticketPurchaseSelect.innerHTML = `<option value="">-- none --</option>` + appState.purchases.map(p => `<option value="${p.id}">${escapeHtml(p.id)} — ${escapeHtml(p.subscription_domain)}</option>`).join('');
 }

 function renderTickets(){

  if(appState.tickets.length==0){

ticketsTbody.innerHTML =`

     <tr>
        <td colspan="5" class="text-center py-4 text-gray-500">
          No Tickets Raised
        </td>
      </tr>
      `
      return;
    
  }
 ticketsTbody.innerHTML = appState.tickets.map(t => {
 return `
 <tr class="ticketRow" data-ticketid="${t.ticket_id}" tabindex="0">
 <td class="py-2 pr-4">${escapeHtml(t.ticket_id)}</td>
 <td class="py-2 pr-4">${escapeHtml(t.subject)}</td>
 <td class="py-2 pr-4">${escapeHtml(t.status)}</td>
 <td class="py-2 pr-4">${new Date(t.created_at).toLocaleString()}</td>
 </tr>
 `;
 }).join('');

 document.querySelectorAll('.ticketRow').forEach(row => {
 row.addEventListener('mouseenter', showTicketHoverDetail);
 row.addEventListener('mouseleave', hideTicketHoverDetail);
 row.addEventListener('focus', showTicketHoverDetail);
 row.addEventListener('blur', hideTicketHoverDetail);
 });
 }

 function showTicketHoverDetail(e){
 const row = e.currentTarget;
 const ticketId = row.dataset.ticketid;
 const ticket = appState.tickets.find(t => t.ticket_id == ticketId);
 if(!ticket) return;
 hoverTicketDetail.innerHTML = `
 <div class="text-sm">
 <div class="font-semibold">${escapeHtml(ticket.subject)}</div>
 <div class="text-xs text-ink-500 mt-1">Status: <strong>${escapeHtml(ticket.status)}</strong></div>
 <div class="mt-2 text-xs text-ink-700">${escapeHtml(ticket.message)}</div>
 <div class="mt-3 text-xs text-ink-500"><strong>Responses:</strong></div>
 <div class="mt-1 text-xs text-ink-700">${ticket.responses && ticket.responses.length ? ticket.responses.map(r => `<div class="mb-1"><strong>${escapeHtml(r.by)}:</strong> ${escapeHtml(r.text)}</div>`).join('') : '<div class="text-xs text-ink-500">No responses yet</div>'}</div>
 </div>
 `;
 const rect = row.getBoundingClientRect();
 hoverTicketDetail.style.left = (Math.min(window.innerWidth - 320, rect.right + 12)) + 'px';
 hoverTicketDetail.style.top = (rect.top + window.scrollY) + 'px';
 hoverTicketDetail.classList.remove('hidden');
 }

 function hideTicketHoverDetail(){ hoverTicketDetail.classList.add('hidden'); }

 newTicketForm.addEventListener('submit', async function(e){
 e.preventDefault();
 const subject = (ticketSubject.value).trim();
 const message = (ticketMessage.value).trim();
 const related_orderId = ticketPurchaseSelect.value;
 if(!subject || !message || !related_orderId){ alert('Please fill subject, message and related orderid.'); return; }
  

        let accessToken = localStorage.getItem('accessToken');
        const formData = new FormData();
        
        formData.append("subject", subject);
        formData.append("message", message);
        formData.append("related_orderId", related_orderId);


        try {
            const res = await fetch("https://hiinterview-backend-1.onrender.com/api/tickets/create/", {

                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                method: "POST",
                body: formData
            });

            if (res.status === 401) {
                accessToken = await refreshAccessToken();
                if (!accessToken) return;
                refreshToken = localStorage.getItem('refreshToken');
                response = await fetch('https://hiinterview-backend-1.onrender.com/api/tickets/create/', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    method: "POST",
                    body: formData
                });
            }

            if (!res.ok) throw new Error("Failed to save profile");
            const data = await res.json();
            renderTickets();
            newTicketForm.reset();
            ticketPurchaseSelect.value = '';
            alert('Ticket created. Support will respond via email.');

        } catch (err) {
            console.error(err);
        }
  });


 // UI: tab navigation
 function showTab(tabId){
 tabContents.forEach(c => c.classList.add('hidden'));
 tabButtons.forEach(b => b.classList.remove('bg-brand-50','text-brand-700','font-semibold'));
 const map = { personal: 'tabPersonal', purchases: 'tabPurchases', tickets: 'tabTickets', extras: 'tabExtras' };
 const elId = map[tabId] || 'tabPersonal';
 document.getElementById(elId).classList.remove('hidden');
 document.querySelectorAll('.tabBtn').forEach(btn => {
 if(btn.dataset.tab === tabId) btn.classList.add('bg-brand-50','text-brand-700','font-semibold');
 });
 }
 tabButtons.forEach(btn => btn.addEventListener('click', ()=> showTab(btn.dataset.tab)));

 // header buttons
 document.getElementById('refreshBtnTop').addEventListener('click', () => {

 populateAll();
 alert('Dashboard refreshed.');
 });
 document.getElementById('logoutBtn').addEventListener('click', logout)
  document.getElementById('logoutBtnTop').addEventListener('click', logout)



  async function logout() {
            let accessToken = localStorage.getItem('accessToken');
            let refreshToken = localStorage.getItem('refreshToken');

            if (!refreshToken) {
                clearTokensAndRedirect();
                return;
            }

            try {
                let response = await fetch('https://hiinterview-backend-1.onrender.com/api/logout/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ refresh: refreshToken })
                });

                if (response.status === 401) {
                    accessToken = await refreshAccessToken();
                    if (!accessToken) return; 
                    refreshToken = localStorage.getItem('refreshToken');
                    response = await fetch('https://hiinterview-backend-1.onrender.com/api/logout/', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ refresh: refreshToken })
                    });
                }

                if (response.ok) {
                    clearTokensAndRedirect();
                } else {
                  clearTokensAndRedirect();
                    
                }
            } catch (err) {
                console.error(err);
            }
}
 

 // helper on initial load
 function populateAll(){
 renderPurchases();
 renderTicketPurchaseOptions();
 renderTickets();
 }

 // initially load profile
 loadProfile();

 showTab('personal');

 // persist on unload

 });
 </script>
</body>
</html>