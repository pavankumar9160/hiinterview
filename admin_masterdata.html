<!doctype html>
<html lang="en" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin: Master Data â€” Hi Interviews</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ink: { 50: '#f8fafc', 100: '#eef2f7', 200: '#e5eaf1', 300: '#cfd8e3', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#0c1324' },
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
                        'accent-iris': '#8B5CF6', 'accent-mint': '#10B981', 'accent-rose': '#F43F5E', 'accent-amber': '#FBBF24',
                    },
                    fontFamily: { sans: ["Inter", "system-ui", "sans-serif"], heading: ["Poppins", "sans-serif"] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.25,1,0.5,1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                    }
                }
            }
        }
    </script>
    <style>
        .focus-ring:focus-visible { outline: 2px solid rgba(79, 70, 229,.35); outline-offset: 3px }
        .bg-pattern { background-image: radial-gradient(circle at top, rgba(79,70,229,0.08) 0%, transparent 30%), radial-gradient(circle at bottom, rgba(139,92,246,0.08) 0%, transparent 40%); }
        .bg-glass { background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .toggle-switch-bg { transition: background-color .2s ease-in-out; }
        .toggle-switch-dot { transition: transform .2s ease-in-out; }
        input.toggle-checkbox:checked ~ .toggle-switch-bg { background-color: #10B981; }
        input.toggle-checkbox:checked ~ .toggle-switch-bg .toggle-switch-dot { transform: translateX(100%); }
    </style>
</head>
<div id="spinner" class="flex items-center justify-center h-screen" style="display:flex;">
  <div class="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
</div>
<body class="bg-ink-50 text-ink-950 antialiased font-sans content" style="display:none">
    <header class="bg-white/80 backdrop-blur-sm border-b border-ink-100 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="font-semibold tracking-tight text-xl font-heading text-ink-900">Hi Interviews <span class="text-brand-600 font-normal">| Admin Panel</span></h1>
                <a href="admin_map.html" class="text-sm font-medium text-brand-600 hover:text-brand-800">Back to Admin Map</a>
            </div>
        </div>
    </header>

    <main class="flex-grow bg-pattern">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-ink-800">Master Data Management</h1>
            
            <div class="mt-4 bg-brand-50 border-l-4 border-brand-500 p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0"><i class="fa-solid fa-circle-info text-brand-600"></i></div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-brand-800">Admin Panel Features</h3>
                        <ul class="mt-2 text-sm text-brand-700 list-disc list-inside space-y-1">
                            <li>Click on a user's name or avatar to navigate to their respective profile page.</li>
                            <li>Use the status toggle to activate or deactivate a user's account. <strong class="text-rose-700">Note: An inactive user will not be able to log in.</strong></li>
                            <li>Click the "Chat" button to send a direct message to a user's chat inbox.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Mentors List -->
            <section class="mt-12">
                 <h2 class="text-2xl font-bold text-ink-800">Mentors (Trainers & Buddies)</h2>
                 <div class="mt-6 bg-white/80 backdrop-blur-xl rounded-2xl shadow-md ring-1 ring-black/5 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[600px]">
                            <thead class="bg-ink-50">
                                <tr>
                                    <th class="p-3 text-left font-semibold">Mentor</th>
                                    <th class="p-3 text-left font-semibold">Domain</th>
                                    <th class="p-3 text-left font-semibold">Status</th>
                                    <th class="p-3 text-left font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mentors-table-body" class="divide-y divide-ink-100">
                                <!-- Mentor rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </section>
            
            <div class="my-12 border-t border-ink-200"></div>

            <!-- Candidates List -->
             <section>
                 <h2 class="text-2xl font-bold text-ink-800">Candidates (Students)</h2>
                  <div class="mt-6 bg-white/80 backdrop-blur-xl rounded-2xl shadow-md ring-1 ring-black/5 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[600px]">
                            <thead class="bg-ink-50">
                                <tr>
                                    <th class="p-3 text-left font-semibold">Candidate</th>
                                    <th class="p-3 text-left font-semibold">Joined Date</th>
                                    <th class="p-3 text-left font-semibold">Status</th>
                                    <th class="p-3 text-left font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="candidates-table-body" class="divide-y divide-ink-100">
                                <!-- Candidate rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </section>

        </div>
    </main>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4 animate-fade-in">
        <div class="bg-glass rounded-2xl shadow-lift ring-1 ring-black/5 w-full max-w-lg animate-scale-in">
            <div class="p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-ink-800">Direct Message</h2>
                        <p id="chat-modal-user-name" class="text-sm text-ink-600"></p>
                    </div>
                    <button id="close-chat-modal-btn" class="text-ink-400 hover:text-ink-600 text-2xl">&times;</button>
                </div>
                <div class="mt-6 border-t border-ink-200 pt-6 space-y-4">
                    <div>
                        <label for="chat-message" class="text-sm font-medium text-ink-700">Your Message</label>
                        <textarea id="chat-message" rows="4" class="mt-1 w-full p-3 text-sm rounded-lg border border-ink-200 bg-white focus:ring-1 focus:ring-brand-500 focus:border-brand-500" placeholder="Type your message to the user..."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-chat-btn" class="bg-ink-100 text-ink-700 font-medium py-2 px-4 rounded-lg hover:bg-ink-200 transition text-sm">Cancel</button>
                    <button id="send-chat-btn" class="bg-brand-600 text-white font-medium py-2 px-5 rounded-lg hover:bg-brand-700 transition text-sm">Send Message</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', async function(){
        const qs = (s) => document.querySelector(s);
        const qsa = (s) => document.querySelectorAll(s);

        let mentors = []
        let candidates = []
        let url = "https://hiinterview-backend-1.onrender.com/"

      /*  let mentors = [
            { id: 'kevin', name: 'Mr. Kevin Mathew', email: 'kevin.m@example.com', avatar: 'https://placehold.co/100x100/312e81/e0e7ff?text=KM', domain: 'Python Developer', isActive: true },
            { id: 'biswajit', name: 'Mr. Biswajit Panda', email: 'biswajit.p@example.com', avatar: 'https://placehold.co/100x100/312e81/e0e7ff?text=BP', domain: 'SAP ABAP Consultant', isActive: true },
            { id: 'sara', name: 'Ms. Sara Khan', email: 'sara.k@example.com', avatar: 'https://placehold.co/100x100/312e81/e0e7ff?text=SK', domain: 'Azure DevOps Engineer', isActive: false },
        ];

        let candidates = [
            { id: 'monica', name: 'Monica Geller', email: 'monica@example.com', avatar: 'https://placehold.co/100x100/e0e7ff/312e81?text=M', joined: '2025-09-08', isActive: true },
            { id: 'priya', name: 'Priya Sharma', email: 'priya.s@example.com', avatar: 'https://placehold.co/100x100/e0e7ff/312e81?text=P', joined: '2025-09-05', isActive: true },
            { id: 'rohan', name: 'Rohan Mehta', email: 'rohan.m@example.com', avatar: 'https://placehold.co/100x100/e0e7ff/312e81?text=R', joined: '2025-09-01', isActive: false },
        ]; */

      const accessToken = localStorage.getItem("accessToken") || sessionStorage.getItem("accessToken");
      const role = localStorage.getItem("role") || sessionStorage.getItem("role");
      const spinner = document.getElementById("spinner");
      const content = document.querySelector('.content');

            if (accessToken && role === "Admin") {   
                content.style.display = "block"; 
                spinner.style.display = "none"; 
            }
            else{
                localStorage.clear();
                sessionStorage.clear();
                spinner.style.display = "none"; 
                window.location.href = "login.html"
            }

            try {
                let response = await fetch('https://hiinterview-backend-1.onrender.com/api/users/', {
                    method: 'GET',                
                });

               

                if (response.ok) {
                    const data = await response.json();  
                    console.log("data:", data);

                    data.forEach(d=>{

                          if(d.role=="Mentor"){
                            mentors.push(d)
                            }
                            else if(d.role=="Candidate"){
                                candidates.push(d)
                            }
                    })
                
                } else {
                    console.error('failed to fetch user data');
                }
            } catch (err) {
                console.error(err);
            }

            

        // --- DOM ELEMENTS ---
        const mentorsTableBody = qs('#mentors-table-body');
        const candidatesTableBody = qs('#candidates-table-body');
        const chatModal = qs('#chat-modal');
        const closeModalBtn = qs('#close-chat-modal-btn');
        const cancelChatBtn = qs('#cancel-chat-btn');
        const sendChatBtn = qs('#send-chat-btn');
        const chatModalUserName = qs('#chat-modal-user-name');
        const chatMessageInput = qs('#chat-message');

        let currentChatUser = null;

        // --- RENDER FUNCTIONS ---
        function renderTables() {
            mentorsTableBody.innerHTML = mentors.map(user => `
                <tr>
                    <td class="p-3">
                        <a href="trainer_dashboard.html" class="flex items-center gap-3 group">
                          ${user.profile_photo_url
                                ? `<img src="${user.profile_photo_url}" alt="${user.first_name}" class="h-10 w-10 rounded-full object-cover">`
                                : `<div class="h-10 w-10 rounded-full bg-blue-400 flex items-center justify-center text-white font-bold">
                                    ${user.first_name.split('').slice(0,1).join('')}
                                </div>`
                            }
                            <div>
                                <div class="font-semibold text-ink-800 group-hover:text-brand-600">${user.first_name} ${user.last_name}</div>
                                <div class="text-ink-500">${user.email}</div>
                            </div>
                        </a>
                    </td>
                    <td class="p-3 text-ink-600">${user.domain}</td>
                    <td class="p-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" data-id="${user.id}" data-type="mentor" class="sr-only toggle-checkbox" ${user.is_active ? 'checked' : ''}>
                          <div class="toggle-switch-bg w-10 h-6 bg-ink-200 rounded-full"><div class="toggle-switch-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div></div>
                        </label>
                    </td>
                    <td class="p-3">
                        <button data-id="${user.id}" data-type="mentor" class="chat-btn bg-ink-100 text-ink-700 font-medium py-1 px-3 rounded-md hover:bg-ink-200 text-sm">Chat</button>
                    </td>
                </tr>
            `).join('');

            candidatesTableBody.innerHTML = candidates.map(user => `
                 <tr>
                    <td class="p-3">
                        <a href="profile.html" class="flex items-center gap-3 group">
                             ${user.profile_photo_url
                                ? `<img src="${url}${user.profile_photo_url}" alt="${user.fullname}" class="h-10 w-10 rounded-full object-cover">`
                                : `<div class="h-10 w-10 rounded-full bg-blue-400 flex items-center justify-center text-white font-bold">
                                    ${user.fullname.split('').slice(0,1).join('')}
                                </div>`
                            }
                            <div>
                                <div class="font-semibold text-ink-800 group-hover:text-brand-600">${user.fullname}</div>
                                <div class="text-ink-500">${user.email}</div>
                            </div>
                        </a>
                    </td>
                    <td class="p-3 text-ink-600">${new Date(user.joined_date).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}</td>
                    <td class="p-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" data-id="${user.id}" data-type="candidate" class="sr-only toggle-checkbox" ${user.is_active ? 'checked' : ''}>
                          <div class="toggle-switch-bg w-10 h-6 bg-ink-200 rounded-full"><div class="toggle-switch-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div></div>
                        </label>
                    </td>
                    <td class="p-3">
                        <button data-id="${user.id}" data-type="candidate" class="chat-btn bg-ink-100 text-ink-700 font-medium py-1 px-3 rounded-md hover:bg-ink-200 text-sm">Chat</button>
                    </td>
                </tr>
            `).join('');

            attachTableListeners();
        }

        function openChatModal(user) {
            currentChatUser = user;
            chatModalUserName.textContent = `To: ${user.name}`;
            chatMessageInput.value = '';
            chatModal.classList.remove('hidden');
            chatModal.classList.add('flex');
        }

        function closeChatModal() {
            chatModal.classList.add('hidden');
            chatModal.classList.remove('flex');
            currentChatUser = null;
        }

        function handleSendMessage() {
            if (!currentChatUser || !chatMessageInput.value.trim()) return;
            // Simulate sending message
            console.log(`Sending message to ${currentChatUser.name}: "${chatMessageInput.value.trim()}"`);
            alert(`Message sent to ${currentChatUser.name}!`);
            closeChatModal();
        }

        function attachTableListeners() {
            qsa('.toggle-checkbox').forEach(toggle => {
                toggle.addEventListener('change', async function (e){
                    const { id, type } = e.target.dataset;
                    console.log("id",id,"type",type)
                    const userList = type === 'mentor' ? mentors : candidates;
                    console.log(userList)
                    const user = userList.find(u => u.id === Number(id));
                    console.log("hi",user)
                    user.is_active = e.target.checked;
                    if (user) {
                         try {
                        let response = await fetch(`https://hiinterview-backend-1.onrender.com/api/update-user-status/${user.id}/`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                            },
                             body: JSON.stringify({ is_active: user.is_active })
                        
                        });


                        if (response.ok) {
                            const data = await response.json();  
                            
                            console.log(`${user.email}'s status changed to: ${user.is_active ? 'Active' : 'Inactive'}`);
                            
                        } else {
                            console.error('failed to update user status');
                            e.target.checked = !user.is_active;
                        }
                    } catch (err) {
                        console.error(err);
                    }

                    }
                });
            });

            qsa('.chat-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     const { id, type } = e.target.dataset;
                    const userList = type === 'mentor' ? mentors : candidates;
                    const user = userList.find(u => u.id === id);
                    if(user) openChatModal(user);
                });
            });
        }
        
        // --- EVENT LISTENERS ---
        closeModalBtn.addEventListener('click', closeChatModal);
        cancelChatBtn.addEventListener('click', closeChatModal);
        sendChatBtn.addEventListener('click', handleSendMessage);
        
        // --- INITIALIZATION ---
        renderTables();
    });
    </script>
</body>
</html>