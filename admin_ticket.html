<!doctype html>
<html lang="en">
<head>
 <meta charset="utf-8"/>
 <meta name="viewport" content="width=device-width,initial-scale=1"/>
 <title>Hi Interviews ‚Äî Admin Tickets (Compact)</title>
 <meta name="robots" content="noindex,nofollow" />
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
 <script src="https://cdn.tailwindcss.com"></script>
 <style>
 :root{
 --muted:#94a3b8;
 --accent:#4f46e5;
 --green:#10b981;
 --card-bg: #ffffff;
 --panel-border: rgba(15,23,42,0.04);
 --brand1:#4f46e5;
 }
 html,body{height:100%}
 body{
 font-family:Inter,system-ui,-apple-system;
 background:#f3f6fb;
 margin:0;
 -webkit-font-smoothing:antialiased;
 color:#0f172a;
 }

 /* layout: narrower outer margins, wider left pane */
 .appOuter{
 max-width:1280px;
 margin:8px auto;
 height:calc(100vh - 16px);
 display:grid;
 grid-template-columns:420px 1fr; /* left panel wider */
 gap:8px;
 padding:8px;
 box-sizing:border-box;
 }

 /* panels: reduced radii / padding for compact look */
 .panel{
 background:var(--card-bg);
 border-radius:10px;
 box-shadow:0 6px 18px rgba(12,15,30,0.04);
 overflow:hidden;
 border:1px solid var(--panel-border);
 display:flex;
 flex-direction:column;
 min-height:0;
 }

 /* left pane compact */
 .leftHeader{
 display:flex;
 align-items:center;
 gap:8px;
 padding:10px 12px;
 border-bottom:1px solid var(--panel-border);
 }
 .leftTitle{font-weight:700;font-size:15px}
 .openCount{margin-left:auto;font-size:12px;background:linear-gradient(90deg,var(--green),#34d399);color:white;padding:5px 10px;border-radius:999px;font-weight:700}

 .leftControls{display:flex;gap:6px;padding:8px;border-bottom:1px solid var(--panel-border)}
 .searchInput{flex:1;padding:6px 8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fafbfd;font-size:13px}

 .filterRow{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:8px}
 .filterSelect{padding:7px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:white;font-size:13px}

 .ticketList{overflow:auto;flex:1;padding:6px}
 .ticketItem{
 display:flex;
 gap:8px;
 padding:8px;
 border-radius:8px;
 align-items:flex-start;
 cursor:pointer;
 transition:transform .12s, box-shadow .12s;
 }
 .ticketItem:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(2,6,23,0.04)}
 .avatar{width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px}
 .avatar.candidate{background:linear-gradient(135deg,#6ee7b7,#10b981)}
 .avatar.trainer{background:linear-gradient(135deg,#93c5fd,#6366f1)}
 .avatar.staff{background:linear-gradient(135deg,#fde68a,#f97316);color:#1f2937}
 .ticketMeta{flex:1;min-width:0}
 .ticketTitle{display:flex;justify-content:space-between;align-items:center;gap:6px}
 .ticketTitleLeft{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
 .ticketPreview{font-size:12px;color:var(--muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
 .ticketBadge{font-size:12px;padding:5px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:700}

 /* right pane compact */
 .chatHeader{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:10px 12px;
 border-bottom:1px solid var(--panel-border);
 }
 .chatHeaderLeft{display:flex;align-items:center;gap:10px}
 .chatAvatar{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:16px}
 .chatName{font-weight:800;font-size:15px}
 .chatInfo{font-size:13px;color:var(--muted)}
 .chatBody{
 flex:1;
 padding:12px;
 overflow:auto;
 display:flex;
 flex-direction:column;
 gap:8px;
 background:linear-gradient(180deg,#fbfdff,#f8fbff);
 min-height:0; /* important for flex overflow */
 }
 .centerEmpty{margin:auto;text-align:center;color:var(--muted);padding:12px}
 .msgRow{display:flex;max-width:78%;align-items:flex-end}
 .msgRow.inbound{align-self:flex-start}
 .msgRow.outbound{align-self:flex-end;flex-direction:row-reverse}
 .bubble{padding:10px 12px;border-radius:12px;box-shadow:0 8px 18px rgba(2,6,23,0.04);font-size:14px;line-height:1.25}
 .bubble.inbound{background:linear-gradient(180deg,#ecfdf5,#f0fdf4);border-top-left-radius:6px;color:#064e3b}
 .bubble.outbound{background:linear-gradient(180deg,#eaf2ff,#dbeafe);border-top-right-radius:6px;color:#0f172a}
 .metaSmall{font-size:12px;color:var(--muted);margin-top:6px;text-align:right}
 .composer{display:flex;gap:8px;padding:8px;border-top:1px solid var(--panel-border);align-items:center}
 .composer textarea{flex:1;min-height:48px;resize:none;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:white;font-size:14px}
 .btnPrimary{background:linear-gradient(90deg,var(--accent),#4f46e5);color:white;padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-size:14px}
 .btnGhost{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:6px 8px;border-radius:8px;cursor:pointer;font-size:13px}
 .smallText{font-size:12px;color:var(--muted)}
 .msgMeta{font-size:12px;color:var(--muted);margin-top:6px;text-align:right}
 .attachmentCard{display:inline-flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:white;border:1px solid rgba(15,23,42,0.06)}
.unreadDot {
    width: 18px;                
    height: 18px;
    border-radius: 50%;
    background: var(--brand1);
    display: flex;              
    justify-content: center;
    align-items: center;
    color: white;               
    font-size: 10px;           
    font-weight: bold;
    margin-left: 90%;
}


 /* responsive: hide left pane on small screens */
 @media (max-width:1000px){
 .appOuter{grid-template-columns:1fr;height:100vh}
 .leftHeader{padding:8px}
 .avatar{width:36px;height:36px;font-size:13px}
 .chatAvatar{width:44px;height:44px;font-size:14px}
 .ticketItem{padding:6px}
 .composer textarea{min-height:44px}
 }
 </style>
</head>
<!-- Spinner overlay -->
<div id="spinner" class="fixed inset-0 flex items-center justify-center bg-white z-50" style="display:flex">
    <div class="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin"></div>
</div>
<body class= "content" style="display:none"> 
 <div class="appOuter">
 <!-- LEFT -->
 <div class="panel">
 <div class="leftHeader">
 <div class="leftTitle">Hi Interviews ‚Ä¢ Support</div><br>
  <div><a href="admin_masterdata.html" class="text-sm font-medium text-brand-700 hover:underline">‚Üê Dashboard</a></div>
           
 <div id="openCount" class="openCount">Open 0</div>
 </div>

 <div class="leftControls">
 <input id="searchInput" class="searchInput" placeholder="Search ticket id, subject, username..." />
 <button id="clearSearch" class="btnGhost">Clear</button>
 </div>

 <div class="filterRow">
 <select id="userTypeFilter" class="filterSelect">
 <option value="all">All Types</option>
 <option value="Candidate">Candidates</option>
 <option value="Trainer">Trainers</option>
 <option value="Staff">Staffs</option>
 </select>

 <select id="nameFilter" class="filterSelect">
 <option value="all">All Names</option>
 </select>

 <!--<select id="categoryFilter" class="filterSelect">
 <option value="all">All Categories</option>
 <option value="class">Class Timing</option>
 <option value="salary">Salary</option>
 <option value="promotion">Promotion</option>
 <option value="celebration">Celebration Funds</option>
 <option value="other">Other</option>
 </select>  -->

 <select id="statusFilter" class="filterSelect">
 <option value="all">All Status</option>
 <option value="New">New</option>
 <option value="Open">Open</option>
 <option value="Awaiting">Awaiting</option>
 <option value="Resolved">Resolved</option>
 </select>
 </div>

 <div style="display:flex;gap:6px;padding:8px;border-bottom:1px solid var(--panel-border);">
 <input id="dateFrom" type="date" class="filterSelect"/>
 <input id="dateTo" type="date" class="filterSelect"/>
 </div>

 <div id="ticketList" class="ticketList" role="list" aria-label="Ticket list">
 <!-- items injected here -->
 </div>
 </div>

 <!-- RIGHT -->
 <div class="panel">
 <div class="chatHeader">
 <div class="chatHeaderLeft">
 <div id="chatAvatar" class="chatAvatar" style="background:linear-gradient(135deg,#dbeafe,#6366f1)">HI</div>
 <div>
 <div id="chatName" class="chatName">No ticket selected</div>
 <div id="chatInfo" class="chatInfo">Select a ticket from the left to start</div>
 </div>
 </div>

 <div style="display:flex;gap:8px;align-items:center">
 <div id="ticketBadge" class="ticketBadge">‚Äî</div>
 <button id="resolveBtn" class="btnPrimary" style="display:none">Mark Resolved</button>
 </div>
 </div>

 <div id="chatBody" class="chatBody">
 <div class="centerEmpty">
 <div style="font-weight:700;font-size:16px">Ticket Chat</div>
 <div style="margin-top:6px;color:var(--muted)">No ticket selected by default. Click a ticket on the left to open it.</div>
 </div>
 </div>

 <div id="composerWrap" class="composer" style="display:none">
 <input id="fileAttach" type="file" style="display:none"/>
 <button id="attachBtn" class="btnGhost">üìé</button>
 <textarea id="messageInput" placeholder="Write your message..."></textarea>
 <button id="sendBtn" class="btnPrimary">Send</button>
 <button id="mailBtn" class="btnGhost" title="Send external email">‚úâÔ∏è</button>
 </div>
 </div>
 </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

let demoTickets = [];
let tickets = [];
let selectedTicketId = null;

let spinner = document.getElementById("spinner");
let content = document.querySelector('.content');

let accessToken = localStorage.getItem('accessToken');
let refreshToken = localStorage.getItem('refreshToken');



if (!refreshToken) {
    clearTokensAndRedirect();
    return;
}

async function loadUserTickets() {
  try {
    const response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/tickets/', {
      headers: { Authorization: `Bearer ${accessToken}` },
    });

            if (response.status === 401) {
                accessToken = await refreshAccessToken();
                if (!accessToken) return;
                refreshToken = localStorage.getItem('refreshToken');
                response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/tickets/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },

                });
            }

             if (response.status === 403) {
                spinner.style.display = "none";
                window.location.href = "404.html";
            } else {
                content.style.display = "block";
                spinner.style.display = "none";

            } 
            if (response.ok) {
                const data = await response.json();
                console.log("data",data)
                    
                    if(data.length > 0){

                        console.log("data.tickrts",data.length)
                        data.forEach((d) => {
                            
                            const messages = (d.messages || []).map(m => ({
                                    id: m.id || '', 
                                    from: d.user_name,                 
                                    direction: (m.sender_role === d.role) ? 'inbound' : 'outbound', 
                                    body: m.text || '',  
                                    attachment: m.attachment || '', 
                                    createdAt: m.created_at || '',
                                    is_read_admin: m.is_read_admin || false 
                                }));

                                // Calculate unread count for admin
                                const unreadCount = messages.filter(m => m.is_read_admin === false).length;

                                demoTickets.push({
                                    ticketId: d.ticketID,
                                    userType: d.role,
                                    userName: d.user_name,
                                    userInitials: d.user_name[0],
                                    email: d.email,
                                    contact: d.mobile_number,
                                    category: d.category || '',          
                                    subject: d.subject || '',            
                                    priority: d.priority || 'medium',    
                                    status: d.status,           
                                    createdAt: d.created_at || '',      
                                    unread: unreadCount,   
                                    messages: messages
                                });
                        });
                        console.log('demoTickets',demoTickets)
                         tickets = JSON.parse(JSON.stringify(demoTickets));
                        console.log("tickets",tickets)
                        
                        
                    }
                   
            }
            else {
                  console.error('failed to fetch user data');
              }
    } catch (err) {
        console.error("Profile load error:", err);
    }
}


async function refreshAccessToken() {
        const refreshToken = localStorage.getItem("refreshToken");
        if (!refreshToken) return null;

        try {
            const response = await fetch("https://sandbox.hiinterviews.com/hiinterview_backend/api/token/refresh/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ refresh: refreshToken })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem("accessToken", data.access);
                localStorage.setItem("refreshToken", data.refresh);

                return data.access;
            } else {
                clearTokensAndRedirect();
                return null;
            }
        } catch (err) {
            console.error(err);
            return null;
        }
    }

function clearTokensAndRedirect() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('role')
    window.location.href = "login.html";
}
 

 // refs
 const ticketListEl = document.getElementById('ticketList');
 const openCountEl = document.getElementById('openCount');
 const searchInput = document.getElementById('searchInput');
 const clearSearchBtn = document.getElementById('clearSearch');
 const userTypeFilter = document.getElementById('userTypeFilter');
 const nameFilter = document.getElementById('nameFilter');
 //const categoryFilter = document.getElementById('categoryFilter');
 const statusFilter = document.getElementById('statusFilter');
 const dateFrom = document.getElementById('dateFrom');
 const dateTo = document.getElementById('dateTo');
 const attachBtnEl =  document.getElementById('attachBtn');
 const fileInputEl = document.getElementById('fileAttach');

  // attach controls
 attachBtnEl.addEventListener('click', ()=> fileInputEl.click());
 fileInputEl.addEventListener('change', ()=> {
const files = fileInputEl.files[0] || '';
 showToast(`file selected`);
 });



 const chatAvatar = document.getElementById('chatAvatar');
 const chatName = document.getElementById('chatName');
 const chatInfo = document.getElementById('chatInfo');
 const ticketBadge = document.getElementById('ticketBadge');
 const chatBody = document.getElementById('chatBody');
 const composerWrap = document.getElementById('composerWrap');
 const messageInput = document.getElementById('messageInput');
 const sendBtn = document.getElementById('sendBtn');
 const mailBtn = document.getElementById('mailBtn');
 const resolveBtn = document.getElementById('resolveBtn');

 // helpers
 function formatDate(iso){
 const d = new Date(iso);
 return d.toLocaleString('en-IN',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
 }
 function shorten(text,n=80){ return text && text.length>n? text.slice(0,n-1)+'‚Ä¶' : (text||''); }
 function genAvatarColor(type){
 if(type==='candidate') return 'linear-gradient(135deg,#6ee7b7,#10b981)';
 if(type==='trainer') return 'linear-gradient(135deg,#93c5fd,#6366f1)';
 return 'linear-gradient(135deg,#fde68a,#f97316)';
 }
 function statusText(s){
 if(s==='new') return 'New';
 if(s==='open') return 'Open';
 if(s==='awaiting') return 'Awaiting';
 if(s==='resolved') return 'Resolved';
 return s;
 }
 function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

 // populate name dropdown
 function populateNameFilter(){
 const set = new Map();
 tickets.forEach(t => {
 const key = `${t.userType}|${t.userName}`;
 if(!set.has(key)) set.set(key,{userType:t.userType,userName:t.userName});
 });
 nameFilter.innerHTML = '<option value="all">All Names</option>';
 for(const [key,obj] of set){
 const opt = document.createElement('option'); opt.value = key;
 opt.textContent = `${obj.userName} ‚Ä¢ ${obj.userType[0].toUpperCase()+obj.userType.slice(1)}`;
 nameFilter.appendChild(opt);
 }
 }

 // open count
 function renderOpenCount(){
 const openCount = tickets.filter(t => t.status === 'Open' || t.status === 'Awaiting' || t.status === 'New').length;
 openCountEl.textContent = `Open ${openCount}`;
 }

 // render ticket list
 function renderTicketList(){
 ticketListEl.innerHTML = '';
 const q = (searchInput.value || '').trim().toLowerCase();
 const userTypeVal = userTypeFilter.value;
 const nameVal = nameFilter.value;
 //const cat = categoryFilter.value;
 const st = statusFilter.value;
 const from = dateFrom.value? new Date(dateFrom.value): null;
 const to = dateTo.value? new Date(dateTo.value): null;

 const filtered = tickets.filter(t => {
 if(userTypeVal!=='all' && t.userType!==userTypeVal) return false;
 if(nameVal!=='all'){ const [uType,uName] = nameVal.split('|'); if(t.userType!==uType || t.userName!==uName) return false; }
 //if(cat!=='all' && t.category!==cat) return false;
 if(st!=='all' && t.status!==st) return false;
 if(from && new Date(t.createdAt) < from) return false;
 if(to){ const toEnd = new Date(to); toEnd.setHours(23,59,59,999); if(new Date(t.createdAt) > toEnd) return false; }
 if(q){
 const hay = `${t.ticketId} ${t.subject} ${t.userName} ${t.messages.map(m=>m.body).join(' ')}`.toLowerCase();
 if(!hay.includes(q)) return false;
 }
 return true;
 }).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

 if(filtered.length === 0){
 ticketListEl.innerHTML = '<div style="padding:10px;color:var(--muted)">No tickets match filters</div>';
 return;
 }

 for(const t of filtered){
 const item = document.createElement('div'); item.className='ticketItem';
 const avatar = document.createElement('div'); avatar.className='avatar '+t.userType; avatar.style.background = genAvatarColor(t.userType); avatar.textContent = t.userInitials || (t.userName||'').split(' ').map(p=>p[0]).slice(0,2).join('');
 const meta = document.createElement('div'); meta.className='ticketMeta';
 const title = document.createElement('div'); title.className='ticketTitle';
 const left = document.createElement('div'); left.className='ticketTitleLeft'; left.textContent = `${t.userName} ‚Ä¢ ${t.subject}`;
 const right = document.createElement('div'); right.style.textAlign = 'right';
 const date = document.createElement('div'); date.className='smallText'; date.textContent = formatDate(t.createdAt);
 const badge = document.createElement('div'); badge.className='ticketBadge'; badge.textContent = statusText(t.status);
 right.appendChild(date); right.appendChild(badge);
 title.appendChild(left); title.appendChild(right);
 const preview = document.createElement('div'); preview.className='ticketPreview'; preview.textContent = shorten(t.messages[t.messages.length-1].body, 90);
 meta.appendChild(title); meta.appendChild(preview);
  if(t.unread && t.unread > 0){
 const unreadEl = document.createElement('div'); unreadEl.className='unreadDot'; unreadEl.textContent = `${t.unread}`;
 meta.appendChild(unreadEl);
 }
 item.appendChild(avatar); item.appendChild(meta);
item.addEventListener('click', async function(){
 selectedTicketId = t.ticketId;
 console.log(selectedTicketId)
 if(t.unread && t.unread > 0){
 try {
    const response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/api/updateAdminMessageReadCount/', {
      method: 'POST',
      headers: { 
        Authorization: `Bearer ${accessToken}`,
        "Content-Type":"application/json"
    },
       body:JSON.stringify({TicketId:selectedTicketId})
    });

            if (response.status === 401) {
                accessToken = await refreshAccessToken();
                if (!accessToken) return;
                refreshToken = localStorage.getItem('refreshToken');
                response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/api/updateAdminMessageReadCount/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                     body:JSON.stringify({TicketId:selectedTicketId})

                });
            }

           if (response.status === 403) {
                spinner.style.display = "none";
                window.location.href = "404.html";
            } else {
                content.style.display = "block";
                spinner.style.display = "none";

            }
            if (response.ok) {
                const data = await response.json();
                console.log("data",data)
                    t.unread = 0;

                    
                   
            }
            else {
                  console.error('failed to fetch user data');
              }
    } catch (err) {
        console.error("Profile load error:", err);
    }
} 

  renderTicketList();
 openTicket(t.ticketId);
 }); ticketListEl.appendChild(item);
 }
 }

 // open ticket
 function openTicket(ticketId){
 selectedTicketId = ticketId;
 const t = tickets.find(x => x.ticketId === ticketId);
 if(!t){ console.warn('Ticket not found', ticketId); return; }
 chatName.textContent = `${t.userName} ‚Ä¢ ${t.userType[0].toUpperCase()+t.userType.slice(1)}`;
 chatInfo.innerHTML = `<span class="smallText">${escapeHtml(t.email)}</span> ‚Ä¢ <span class="smallText">${escapeHtml(t.contact)}</span>`;
 ticketBadge.textContent = t.ticketId;
 ticketBadge.title = t.subject;
 chatAvatar.textContent = t.userInitials || (t.userName||'').split(' ').map(p=>p[0]).slice(0,2).join('');
 chatAvatar.style.background = genAvatarColor(t.userType);

 if(t.status=="Resolved"){
     composerWrap.style.display = 'none';
    resolveBtn.style.display = 'none';
    chatBody.innerHTML = '<div class="centerEmpty"><div style="font-weight:700">No ticket selected</div><div style="margin-top:6px;color:var(--muted)">Select a ticket from the left to view its conversation.</div></div>';
    selectedTicketId = null;
 }
 else{
composerWrap.style.display = 'flex';
 resolveBtn.style.display = 'inline-block';
 }
 

 // render messages compact
 chatBody.innerHTML = '';
 for(const m of t.messages){
 const row = document.createElement('div'); row.className = 'msgRow ' + (m.direction === 'inbound' ? 'inbound' : 'outbound');
 const bubble = document.createElement('div'); bubble.className = 'bubble ' + (m.direction === 'inbound' ? 'inbound' : 'outbound');
 const url = 'https://sandbox.hiinterviews.com/hiinterview_backend';
                const attachment_url = `${url}${m.attachment}`;
const attachmentHtml = m.attachment
  ? `<div style="margin-top:6px">
        <div class="attachmentCard">
            ${
              m.attachment.match(/\.(jpeg|jpg|gif|png|webp)$/i)
                ? `<img src="${attachment_url}" 
                        alt="attachment" 
                        style="max-width:200px; border-radius: 8px; cursor: pointer;" 
                        onclick="window.open('${attachment_url}', '_blank')" />`
                : `<a href="${attachment_url}" target="_blank" rel="noopener noreferrer">
                      ${escapeHtml(attachment_url)}
                   </a>`
            }
        </div>
    </div>`
  : '';

bubble.innerHTML = `
    <div>${escapeHtml(m.body)}</div>
    ${attachmentHtml}
    <div class="msgMeta">${formatDate(m.createdAt)}</div>
`;

row.appendChild(bubble);
 chatBody.appendChild(row);
 }
 setTimeout(()=> { chatBody.scrollTop = chatBody.scrollHeight; }, 50);
 }

 // send in-app
 sendBtn.addEventListener('click', async function(){
 if(!selectedTicketId){ showToast('Please select a ticket first'); return; }

 const t = tickets.find(x => x.ticketId === selectedTicketId);
 if(!t){ showToast('Ticket not found'); return; }
 const text = (messageInput.value || '').trim();

 const formData = new FormData();

 const fileName = fileInputEl.files[0];

  if(!text && !fileName){ showToast('Message is empty'); return; }
 if (fileName){
    formData.append("attachment",fileName)
 }
     formData.append("ticketID",selectedTicketId)
     formData.append("text",text)
     formData.append("is_read_admin",true)



 try {
    const response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/messages/create/', {
      method: 'POST',
      headers: { 
        Authorization: `Bearer ${accessToken}`,
        
    },
        body:formData
    });

            if (response.status === 401) {
                accessToken = await refreshAccessToken();
                if (!accessToken) return;
                refreshToken = localStorage.getItem('refreshToken');
                response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/messages/create/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body:formData

                });
            }

           if (response.status === 403) {
                spinner.style.display = "none";
                window.location.href = "404.html";
            } else {
                content.style.display = "block";
                spinner.style.display = "none";

            }
            if (response.ok) {
                const data = await response.json();
                console.log("data creted message",data)

                const msg = { id:data.id, direction:'outbound',attachment: data.attachment,from: 'Admin', body: data.text, createdAt: data.created_at };
                t.messages.push(msg);
                    
                    messageInput.value = '';
                    fileInputEl.value = '';
                   
                    openTicket(selectedTicketId);
                    renderTicketList();
                    renderOpenCount();
                    showToast('Reply sent (in-app)');
                    
            }
            else {
                  console.error('failed to fetch user data');
              }
    } catch (err) {
        console.error("Profile load error:", err);
    }




// const msg = { id: 'm' + Date.now(), direction: 'outbound', from: 'Admin', body: text, createdAt: new Date().toISOString() };
// t.messages.push(msg);
// t.status = 'awaiting';
// t.audit = t.audit || []; t.audit.push({ user: 'Admin', action: 'Sent reply (in-app)', note: text, at: new Date().toISOString() });
// messageInput.value = '';
// openTicket(selectedTicketId);
// renderTicketList();
 
 // TODO: POST to your backend: POST /api/tickets/:id/messages
 });

 // external mailto
 mailBtn.addEventListener('click', () => {
 if(!selectedTicketId){ showToast('Please select a ticket first'); return; }
 const t = tickets.find(x => x.ticketId === selectedTicketId);
 const subject = `Re: [${t.ticketId}] ${t.subject}`;
 const body = `Hi ${t.userName},%0D%0A%0D%0ARef: ${t.ticketId}%0D%0A%0D%0A`;
 window.open(`mailto:${encodeURIComponent(t.email)}?subject=${encodeURIComponent(subject)}&body=${body}`);
 showToast('External email composer opened');
 });

 // resolve
 resolveBtn.addEventListener('click', async function() {
 if(!selectedTicketId){ showToast('Please select a ticket'); return; }
 if(!confirm('Mark this ticket as resolved?')) return;
 const t = tickets.find(x => x.ticketId === selectedTicketId);
 const status = "Resolved"
 try {
    const response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/tickets/update-status/', {
      method: 'POST',
      headers: { 
        Authorization: `Bearer ${accessToken}`,
        "Content-Type":"application/json"
    },
       body:JSON.stringify({ticketID:selectedTicketId,status:status})
    });

            if (response.status === 401) {
                accessToken = await refreshAccessToken();
                if (!accessToken) return;
                refreshToken = localStorage.getItem('refreshToken');
                response = await fetch('https://sandbox.hiinterviews.com/hiinterview_backend/tickets/update-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                   body:JSON.stringify({ticketID:selectedTicketId,status:status})

                });
            }

           if (response.status === 403) {
                spinner.style.display = "none";
                window.location.href = "404.html";
            } else {
                content.style.display = "block";
                spinner.style.display = "none";

            }
            if (response.ok) {
                const data = await response.json();
                console.log("data creted message",data)
                t.status = 'Resolved';
               // t.audit = t.audit || []; t.audit.push({ user: 'Admin', action: 'Marked resolved', at: new Date().toISOString() });
                composerWrap.style.display = 'none';
                resolveBtn.style.display = 'none';
                chatBody.innerHTML = '<div class="centerEmpty"><div style="font-weight:700">No ticket selected</div><div style="margin-top:6px;color:var(--muted)">Select a ticket from the left to view its conversation.</div></div>';
                selectedTicketId = null;
                renderTicketList();
                renderOpenCount();
                showToast('Ticket marked resolved');
                    
            }
            else {
                  console.error('failed to fetch user data');
              }
    } catch (err) {
        console.error("Profile load error:", err);
    }

 // TODO: POST /api/tickets/:id/resolve
 });

 // filters & events
 searchInput.addEventListener('input', () => renderTicketList());
 clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; renderTicketList(); });
 userTypeFilter.addEventListener('change', () => { populateNameFilter(); renderTicketList(); });
 nameFilter.addEventListener('change', () => renderTicketList());
 //categoryFilter.addEventListener('change', () => renderTicketList());
 statusFilter.addEventListener('change', () => renderTicketList());
 dateFrom.addEventListener('change', () => renderTicketList());
 dateTo.addEventListener('change', () => renderTicketList());

 // toast
 const toastEl = document.createElement('div');
 toastEl.style.position='fixed'; toastEl.style.right='16px'; toastEl.style.bottom='16px';
 toastEl.style.padding='8px 12px'; toastEl.style.background='rgba(17,24,39,0.9)'; toastEl.style.color='white';
 toastEl.style.borderRadius='8px'; toastEl.style.display='none'; toastEl.style.zIndex='9999';
 document.body.appendChild(toastEl);
 function showToast(txt,d=1800){ toastEl.textContent = txt; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none', d); }

 // keyboard shortcuts
/* document.addEventListener('keydown', (e) => {
 if((e.key === 'r' || e.key === 'R') && selectedTicketId){ messageInput.focus(); }
 if((e.key === 'm' || e.key === 'M') && selectedTicketId){ resolveBtn.click(); }
 });*/

  


 
 // init
 async function init(){

await loadUserTickets();
 populateNameFilter();
 renderTicketList();
 renderOpenCount();
 // default: no ticket selected; header already shows that
 console.info('Admin UI (compact) ready');
 }
 init();

}); // DOMContentLoaded
</script>
</body>
</html>

